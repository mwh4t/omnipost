{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OmniPost</title>
    <link rel="icon" type="image/png" href="{% static 'images/logo-white.png' %}">
    <link rel="stylesheet" href="{% static 'css/home.css' %}">
</head>
<body>
<header>
    <div class="header-content">
        <img src="{% static 'images/logo-white.png' %}" alt="logo" style="width: 80px; height: 80px;">
        <button class="btn-profile" id="openProfileModal">
            <img src="{% static 'images/profile-icon.png' %}" alt="Profile" style="width: 32px; height: 32px;">
        </button>
    </div>
</header>

<div class="container">
    <div class="social-section">
        <div class="social-connect-btn" id="vkConnectBtn">
            <img src="{% static 'images/vk-hlogo.png' %}" alt="VK" class="social-hlogo">
            <div class="social-input-wrapper">
                <input type="text" class="social-input" placeholder="VK GROUP ID...">
                <button type="button" class="social-add-btn">+</button>
            </div>
        </div>
        <div class="social-connect-btn" id="tgConnectBtn">
            <img src="{% static 'images/tg-hlogo.png' %}" alt="Telegram" class="social-hlogo">
            <div class="social-input-wrapper">
                <input type="text" class="social-input" placeholder="TG CHANNEL ID...">
                <button type="button" class="social-add-btn">+</button>
            </div>
        </div>
    </div>

    <div class="editor-section">
        <div class="editor-wrapper">
            <textarea id="postText" placeholder="Write your post here..."></textarea>

            <div class="attachment-bar">
                <button type="button" class="attach-btn" onclick="document.getElementById('fileInput').click()">
                    &#128206; Attach File
                </button>
                <input type="file" id="fileInput" class="file-input" multiple>
                <span class="file-name" id="fileName"></span>
            </div>
        </div>
    </div>

    <div class="publish-section">
        <button type="button" class="btn-publish" id="publishBtn">Publish</button>
    </div>
</div>

<!-- модальное окно профиля -->
<div id="profileModal" class="modal">
    <div class="modal-content modal-profile">
        <span class="close-modal" id="closeProfileModal">&times;</span>

        {% if user %}
        <!-- авторизован -->
        <div class="profile-info">
            <div class="profile-email">{{ user.email }}</div>

            <div class="profile-socials">
                {% if vk_connected %}
                <a href="{% url 'vk_disconnect' %}" class="social-login-btn vk connected" title="Отключить VK">
                    <img src="{% static 'images/vkon-icon.png' %}" alt="VK" class="icon-default">
                    <img src="{% static 'images/vkoff-icon.png' %}" alt="VK" class="icon-hover">
                </a>
                {% else %}
                <a href="{% url 'vk_login' %}" class="social-login-btn vk" title="Подключить VK">
                    <img src="{% static 'images/vk-icon.png' %}" alt="VK">
                </a>
                {% endif %}

                {% if tg_connected %}
                <a href="{% url 'tg_disconnect' %}" class="social-login-btn tg connected" title="Отключить Telegram">
                    <img src="{% static 'images/tgon-icon.png' %}" alt="Telegram" class="icon-default">
                    <img src="{% static 'images/tgoff-icon.png' %}" alt="Telegram" class="icon-hover">
                </a>
                {% else %}
                <button type="button" class="social-login-btn tg" id="openTgModal" title="Подключить Telegram">
                    <img src="{% static 'images/tg-icon.png' %}" alt="Telegram">
                </button>
                {% endif %}
            </div>

            <a href="{% url 'logout' %}" class="btn-logout">Logout</a>
        </div>
        {% else %}
        <!-- не авторизован -->
        <div id="error-message" class="error-message" style="display: none;"></div>

        <form id="authForm" method="POST" action="{% url 'email_auth' %}">
            {% csrf_token %}
            <input type="hidden" name="action" id="authAction" value="login">

            <div class="input-group">
                <label>Email</label>
                <input type="email" name="email" id="email" required>
            </div>

            <div class="input-group">
                <label>Password</label>
                <input type="password" name="password" id="password" required>
            </div>

            <div class="auth-buttons">
                <button type="submit" class="btn-login" onclick="document.getElementById('authAction').value='login'">Login</button>
                <button type="submit" class="btn-register" onclick="document.getElementById('authAction').value='register'">Register</button>
            </div>
        </form>

        <div class="divider">or</div>

        <a href="{% url 'google_login' %}" class="google-btn">
            <img src="{% static 'images/google-icon.png' %}" alt="Google" style="width: 20px; height: 20px;">
            Login with Google
        </a>
        {% endif %}
    </div>
</div>

{% if error %}
<script>
    document.getElementById('error-message').textContent = "{{ error }}";
    document.getElementById('error-message').style.display = 'block';
    document.getElementById('profileModal').style.display = 'block';
    document.getElementById('profileModal').classList.add('active');
</script>
{% endif %}

<!-- модальное окно tg авторизации -->
<div id="tgModal" class="modal">
    <div class="modal-content modal-tg">
        <span class="close-modal" id="closeTgModal">&times;</span>
        <h3 style="color: #fff; margin-bottom: 20px; text-align: center;">Подключить Telegram</h3>

        <div id="tg-error-message" class="error-message" style="display: none;"></div>

        <!-- ввод номера телефона -->
        <div id="tgStep1">
            <div class="input-group">
                <label>Номер телефона</label>
                <input type="tel" id="tgPhone" placeholder="+7 999 123 4567" required>
            </div>
            <button type="button" class="btn-login" id="tgSendCodeBtn" style="width: 100%;">Получить код</button>
        </div>

        <!-- ввод кода -->
        <div id="tgStep2" style="display: none;">
            <div class="input-group">
                <label>Код из Telegram</label>
                <input type="text" id="tgCode" placeholder="12345" required>
            </div>
            <div class="input-group" id="tg2faGroup" style="display: none;">
                <label>Пароль 2FA</label>
                <input type="password" id="tg2faPassword" placeholder="Ваш пароль">
            </div>
            <button type="button" class="btn-login" id="tgVerifyCodeBtn" style="width: 100%;">Подтвердить</button>
        </div>
    </div>
</div>

<script>
    // массивы для хранения добавленных групп и каналов
    let vkGroups = [];
    let tgChannels = [];

    // файлы
    const fileInput = document.getElementById('fileInput');
    const fileName = document.getElementById('fileName');
    if (fileInput) {
        fileInput.addEventListener('change', function () {
            if (this.files.length > 0) {
                const names = Array.from(this.files).map(f => f.name).join(', ');
                fileName.textContent = names;
            } else {
                fileName.textContent = '';
            }
        });
    }

    // добавление VK группы
    const vkInput = document.querySelector('#vkConnectBtn .social-input');
    const vkAddBtn = document.querySelector('#vkConnectBtn .social-add-btn');

    if (vkAddBtn && vkInput) {
        vkAddBtn.addEventListener('click', function() {
            const groupId = vkInput.value.trim();
            if (groupId && !vkGroups.includes(groupId)) {
                vkGroups.push(groupId);
                vkInput.value = '';
                console.log('VK группы:', vkGroups);
                alert(`VK группа ${groupId} добавлена`);
            } else if (vkGroups.includes(groupId)) {
                alert('Эта группа уже добавлена');
            }
        });
    }

    // добавление Telegram канала
    const tgInput = document.querySelector('#tgConnectBtn .social-input');
    const tgAddBtn = document.querySelector('#tgConnectBtn .social-add-btn');

    if (tgAddBtn && tgInput) {
        tgAddBtn.addEventListener('click', function() {
            const channelId = tgInput.value.trim();
            if (channelId && !tgChannels.includes(channelId)) {
                tgChannels.push(channelId);
                tgInput.value = '';
                console.log('Telegram каналы:', tgChannels);
                alert(`Telegram канал ${channelId} добавлен`);
            } else if (tgChannels.includes(channelId)) {
                alert('Этот канал уже добавлен');
            }
        });
    }

    // публикация поста
    const publishBtn = document.getElementById('publishBtn');
    if (publishBtn) {
        publishBtn.addEventListener('click', async function() {
            const text = document.getElementById('postText').value.trim();
            const files = fileInput.files;

            // проверка на наличие контента
            if (!text && files.length === 0) {
                alert('Добавьте текст или изображение');
                return;
            }

            // проверка на наличие групп/каналов
            if (vkGroups.length === 0 && tgChannels.length === 0) {
                alert('Добавьте хотя бы одну группу VK или канал Telegram');
                return;
            }

            // создание FormData для отправки
            const formData = new FormData();
            formData.append('text', text);
            formData.append('vk_groups', vkGroups.join(','));
            formData.append('tg_channels', tgChannels.join(','));

            // добавление файлов
            for (let i = 0; i < files.length; i++) {
                formData.append('files', files[i]);
            }

            // отключение кнопки и показ загрузки
            publishBtn.disabled = true;
            publishBtn.textContent = 'ПУБЛИКАЦИЯ...';

            try {
                const response = await fetch('{% url "publish_post" %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    alert('Пост успешно опубликован!');

                    // очистка формы
                    document.getElementById('postText').value = '';
                    fileInput.value = '';
                    fileName.textContent = '';
                    vkGroups = [];
                    tgChannels = [];
                } else {
                    let errorMsg = 'Ошибка публикации:\n';

                    if (data.errors && data.errors.length > 0) {
                        errorMsg += data.errors.join('\n');
                    } else {
                        errorMsg += data.error || 'Неизвестная ошибка';
                    }

                    alert(errorMsg);
                }
            } catch (error) {
                alert('Ошибка соединения: ' + error.message);
            } finally {
                publishBtn.disabled = false;
                publishBtn.textContent = 'PUBLISH';
            }
        });
    }

    // модальное окно профиля
    const profileModal = document.getElementById('profileModal');
    const openProfileBtn = document.getElementById('openProfileModal');
    const closeProfileBtn = document.getElementById('closeProfileModal');

    if (openProfileBtn) {
        openProfileBtn.addEventListener('click', function() {
            profileModal.style.display = 'block';
            setTimeout(() => {
                profileModal.classList.add('active');
            }, 10);
        });
    }

    // модальное окно telegram
    const tgModal = document.getElementById('tgModal');
    const openTgModalBtn = document.getElementById('openTgModal');
    const closeTgModalBtn = document.getElementById('closeTgModal');

    if (openTgModalBtn) {
        openTgModalBtn.addEventListener('click', function() {
            tgModal.style.display = 'block';
            setTimeout(() => {
                tgModal.classList.add('active');
            }, 10);
        });
    }

    if (closeTgModalBtn) {
        closeTgModalBtn.addEventListener('click', () => closeModal(tgModal));
    }

    // telegram авторизация
    const tgSendCodeBtn = document.getElementById('tgSendCodeBtn');
    const tgVerifyCodeBtn = document.getElementById('tgVerifyCodeBtn');
    const tgErrorMessage = document.getElementById('tg-error-message');

    function showTgError(message) {
        tgErrorMessage.textContent = message;
        tgErrorMessage.style.display = 'block';
    }

    function hideTgError() {
        tgErrorMessage.style.display = 'none';
    }

    if (tgSendCodeBtn) {
        tgSendCodeBtn.addEventListener('click', async function() {
            hideTgError();
            const phone = document.getElementById('tgPhone').value.trim();

            if (!phone) {
                showTgError('Введите номер телефона');
                return;
            }

            tgSendCodeBtn.disabled = true;
            tgSendCodeBtn.textContent = 'Отправка...';

            try {
                const response = await fetch('{% url "tg_send_code" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ phone: phone })
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('tgStep1').style.display = 'none';
                    document.getElementById('tgStep2').style.display = 'block';
                } else {
                    showTgError(data.error || 'Ошибка отправки кода');
                }
            } catch (e) {
                showTgError('Ошибка соединения');
            } finally {
                tgSendCodeBtn.disabled = false;
                tgSendCodeBtn.textContent = 'Получить код';
            }
        });
    }

    if (tgVerifyCodeBtn) {
        tgVerifyCodeBtn.addEventListener('click', async function() {
            hideTgError();
            const code = document.getElementById('tgCode').value.trim();
            const password = document.getElementById('tg2faPassword').value;

            if (!code) {
                showTgError('Введите код');
                return;
            }

            tgVerifyCodeBtn.disabled = true;
            tgVerifyCodeBtn.textContent = 'Проверка...';

            try {
                const response = await fetch('{% url "tg_verify_code" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ code: code, password: password })
                });

                const data = await response.json();

                if (data.success) {
                    window.location.reload();
                } else if (data.error === '2fa_required') {
                    document.getElementById('tg2faGroup').style.display = 'block';
                    showTgError('Требуется пароль двухфакторной аутентификации');
                } else {
                    showTgError(data.error || 'Ошибка верификации');
                }
            } catch (e) {
                showTgError('Ошибка соединения');
            } finally {
                tgVerifyCodeBtn.disabled = false;
                tgVerifyCodeBtn.textContent = 'Подтвердить';
            }
        });
    }

    function closeModal(modal) {
        modal.classList.remove('active');
        setTimeout(() => {
            modal.style.display = 'none';
        }, 400);
    }

    if (closeProfileBtn) {
        closeProfileBtn.addEventListener('click', () => closeModal(profileModal));
    }

    window.addEventListener('click', function(event) {
        if (event.target === profileModal) {
            closeModal(profileModal);
        }
        if (event.target === tgModal) {
            closeModal(tgModal);
        }
    });
</script>
</body>
</html>
