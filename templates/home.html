{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OmniPost</title>
    <link rel="icon" type="image/png" href="{% static 'images/logo-white.png' %}">
    <link rel="stylesheet" href="{% static 'css/home.css' %}">
</head>
<body>
<header>
    <div class="header-content">
        <img src="{% static 'images/logo-white.png' %}" alt="logo" style="width: 80px; height: 80px;">
        <button class="btn-profile" id="openProfileModal">
            <img src="{% static 'images/profile-icon.png' %}" alt="Profile" style="width: 32px; height: 32px;">
        </button>
    </div>
</header>

<div class="container">
    <div class="social-section">
        <div class="social-connect-btn{% if not vk_connected %} disabled{% endif %}" id="vkConnectBtn" {% if not vk_connected %}style="opacity:0.5;pointer-events:none;"{% endif %}>
            <img src="{% static 'images/vk-hlogo.png' %}" alt="VK" class="social-hlogo">
            {% if vk_connected %}
            <div class="social-input-wrapper">
                <input type="text" class="social-input social-group-id" placeholder="GROUP ID...">
                <input type="text" class="social-input social-group-token" placeholder="ACCESS TOKEN...">
                <button type="button" class="social-add-btn">+</button>
            </div>
            {% endif %}
            <button type="button" class="list-toggle-btn" id="toggleVkList" title="CHOOSE GROUPS">☰</button>
        </div>

        <div class="social-connect-btn{% if not tg_connected %} disabled{% endif %}" id="tgConnectBtn"{% if not tg_connected %} style="opacity:0.5;pointer-events:none;"{% endif %}>
            <img src="{% static 'images/tg-hlogo.png' %}" alt="Telegram" class="social-hlogo">
            <div class="social-input-wrapper">
                <input type="text" class="social-input" placeholder="CHANNEL ID...">
                <button type="button" class="social-add-btn">+</button>
            </div>
        </div>
        <button type="button" class="list-toggle-btn{% if not tg_connected %} disabled{% endif %}" id="toggleTgList" title="CHOOSE CHANNELS"{% if not tg_connected %} style="opacity:0.5;pointer-events:none;"{% endif %}>☰</button>
    </div>

    <!-- выпадающий список vk -->
    <div id="vkDropdown" class="dropdown-panel">
        <div class="dropdown-header">
            <span>VK Группы (<span id="vkSelectedCount">0</span> CHOSEN)</span>
            <button class="dropdown-close" onclick="closeVkDropdown()">✕</button>
        </div>
        <div id="vkGroupsList" class="dropdown-body">
            <div class="no-groups">NO GROUPS SAVED</div>
        </div>
    </div>

    <!-- выпадающий список tg -->
    <div id="tgDropdown" class="dropdown-panel">
        <div class="dropdown-header">
            <span>Telegram Каналы (<span id="tgSelectedCount">0</span> CHOSEN)</span>
            <button class="dropdown-close" onclick="closeTgDropdown()">✕</button>
        </div>
        <div id="tgChannelsList" class="dropdown-body">
            <div class="no-groups">NO CHANNELS SAVED</div>
        </div>
    </div>

    <div class="editor-section">
        <div class="editor-wrapper">
            <textarea id="postText" placeholder="WRITE YOUR POST HERE..."></textarea>

            <div class="attachment-bar">
                <button type="button" class="attach-btn" onclick="document.getElementById('fileInput').click()">
                    &#128206; ATTACH FILE
                </button>
                <input type="file" id="fileInput" class="file-input" multiple>
                <span class="file-name" id="fileName"></span>
                <button type="button" class="schedule-btn" id="scheduleBtn" title="Запланировать публикацию">
                    &#128197;
                </button>
            </div>
        </div>
    </div>

    <div class="publish-section">
        <button type="button" class="btn-publish" id="publishBtn">PUBLISH</button>
    </div>
</div>

<!-- модальное окно профиля -->
<div id="profileModal" class="modal">
    <div class="modal-content modal-profile">
        <span class="close-modal" id="closeProfileModal">&times;</span>

        {% if user %}
        <!-- авторизован -->
        <div class="profile-info">
            <div class="profile-email">{{ user.email }}</div>

            <div class="profile-socials">
                {% if vk_connected %}
                <a href="{% url 'vk_disconnect' %}" class="social-login-btn vk connected" title="DISABLE VK">
                    <img src="{% static 'images/vkon-icon.png' %}" alt="VK" class="icon-default">
                    <img src="{% static 'images/vkoff-icon.png' %}" alt="VK" class="icon-hover">
                </a>
                {% else %}
                <a href="{% url 'vk_login' %}" class="social-login-btn vk" title="CONNECT VK">
                    <img src="{% static 'images/vk-icon.png' %}" alt="VK">
                </a>
                {% endif %}

                {% if tg_connected %}
                <a href="{% url 'tg_disconnect' %}" class="social-login-btn tg connected" title="DISABLE TG">
                    <img src="{% static 'images/tgon-icon.png' %}" alt="Telegram" class="icon-default">
                    <img src="{% static 'images/tgoff-icon.png' %}" alt="Telegram" class="icon-hover">
                </a>
                {% else %}
                <button type="button" class="social-login-btn tg" id="openTgModal" title="CONNECT TG">
                    <img src="{% static 'images/tg-icon.png' %}" alt="Telegram">
                </button>
                {% endif %}
            </div>

            <a href="{% url 'logout' %}" class="btn-logout">Logout</a>
        </div>
        {% else %}
        <!-- не авторизован -->
        <div id="error-message" class="error-message" style="display: none;"></div>

        <form id="authForm" method="POST" action="{% url 'email_auth' %}">
            {% csrf_token %}
            <input type="hidden" name="action" id="authAction" value="login">

            <div class="input-group">
                <label>Email</label>
                <input type="email" name="email" id="email" required>
            </div>

            <div class="input-group">
                <label>Password</label>
                <input type="password" name="password" id="password" required>
            </div>

            <div class="auth-buttons">
                <button type="submit" class="btn-login" onclick="document.getElementById('authAction').value='login'">Login</button>
                <button type="submit" class="btn-register" onclick="document.getElementById('authAction').value='register'">Register</button>
            </div>
        </form>

        <div class="divider">or</div>

        <a href="{% url 'google_login' %}" class="google-btn">
            <img src="{% static 'images/google-icon.png' %}" alt="Google" style="width: 20px; height: 20px;">
            LOGIN WITH GOOGLE
        </a>
        {% endif %}
    </div>
</div>

{% if error %}
<script>
    document.getElementById('error-message').textContent = "{{ error }}";
    document.getElementById('error-message').style.display = 'block';
    document.getElementById('profileModal').style.display = 'block';
    document.getElementById('profileModal').classList.add('active');
</script>
{% endif %}

<!-- модальное окно tg авторизации -->
<div id="tgModal" class="modal">
    <div class="modal-content modal-tg">
        <span class="close-modal" id="closeTgModal">&times;</span>
        <h3 style="color: #fff; margin-bottom: 20px; text-align: center;">CONNECT TG</h3>

        <div id="tg-error-message" class="error-message" style="display: none;"></div>

        <!-- ввод номера телефона -->
        <div id="tgStep1">
            <div class="input-group">
                <label>PHONE NUMBER</label>
                <input type="tel" id="tgPhone" placeholder="+7 999 123 4567" required>
            </div>
            <button type="button" class="btn-login" id="tgSendCodeBtn" style="width: 100%;">GET THE CODE</button>
        </div>

        <!-- ввод кода -->
        <div id="tgStep2" style="display: none;">
            <div class="input-group">
                <label>TG code</label>
                <input type="text" id="tgCode" placeholder="12345" required>
            </div>
            <div class="input-group" id="tg2faGroup" style="display: none;">
                <label>PASSWORD 2FA</label>
                <input type="password" id="tg2faPassword" placeholder="YOUR PASSWORD">
            </div>
            <button type="button" class="btn-login" id="tgVerifyCodeBtn" style="width: 100%;">CONFIRM</button>
        </div>
    </div>
</div>

<div id="scheduleModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" id="closeScheduleModal">&times;</span>
        <h3>Запланировать</h3>
        <input type="date" id="scheduleDate">
        <input type="time" id="scheduleTime">
            <div id="schedulePreview" style="margin: 20px 0; color: #fff; text-align: center;"></div>
        <button id="publishNowBtn">Сейчас</button>
        <button id="publishLaterBtn">Позже</button>
    </div>
</div>

<script>
    // Состояние выбранных групп
    let selectedVkGroups = [];
    let selectedTgChannels = [];
    let scheduledTime = null; // Запланированное время

    // Модальное окно планирования
    const scheduleModal = document.getElementById('scheduleModal');
    const scheduleBtn = document.getElementById('scheduleBtn');
    const closeScheduleModal = document.getElementById('closeScheduleModal');
    const scheduleDateInput = document.getElementById('scheduleDate');
    const scheduleTimeInput = document.getElementById('scheduleTime');
    const schedulePreview = document.getElementById('schedulePreview');
    const publishNowBtn = document.getElementById('publishNowBtn');
    const publishLaterBtn = document.getElementById('publishLaterBtn');

    // Установка минимальной даты (сегодня)
    const today = new Date().toISOString().split('T')[0];
    scheduleDateInput.setAttribute('min', today);

    // Открытие модального окна планирования
    if (scheduleBtn) {
        scheduleBtn.addEventListener('click', function() {
            scheduleModal.style.display = 'block';
            setTimeout(() => {
                scheduleModal.classList.add('active');
            }, 10);

            // Установка текущих даты и времени по умолчанию
            if (!scheduleDateInput.value) {
                scheduleDateInput.value = today;
            }
            if (!scheduleTimeInput.value) {
                const now = new Date();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                scheduleTimeInput.value = `${hours}:${minutes}`;
            }
            updateSchedulePreview();
        });
    }

    // Закрытие модального окна планирования
    if (closeScheduleModal) {
        closeScheduleModal.addEventListener('click', () => closeModal(scheduleModal));
    }

    // Обновление превью запланированного времени
    function updateSchedulePreview() {
        const date = scheduleDateInput.value;
        const time = scheduleTimeInput.value;

        if (date && time) {
            const scheduled = new Date(`${date}T${time}`);
            const now = new Date();

            if (scheduled <= now) {
                schedulePreview.innerHTML = '<span style="color: #ff6b6b;">⚠️ Выбранное время уже прошло</span>';
                publishLaterBtn.disabled = true;
            } else {
                const diff = scheduled - now;
                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

                const formatter = new Intl.DateTimeFormat('ru-RU', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                schedulePreview.innerHTML = `
                    <strong>Публикация запланирована на:</strong><br>
                    ${formatter.format(scheduled)}<br>
                    <span style="color: #888;">(через ${hours} ч ${minutes} мин)</span>
                `;
                publishLaterBtn.disabled = false;
            }
        }
    }

    // Обновление превью при изменении даты/времени
    if (scheduleDateInput) {
        scheduleDateInput.addEventListener('change', updateSchedulePreview);
    }
    if (scheduleTimeInput) {
        scheduleTimeInput.addEventListener('input', updateSchedulePreview);
    }

    // Публикация сейчас
    if (publishNowBtn) {
        publishNowBtn.addEventListener('click', function() {
            scheduledTime = null;
            closeModal(scheduleModal);
            publishPost();
        });
    }

    // Запланировать публикацию
    if (publishLaterBtn) {
        publishLaterBtn.addEventListener('click', function() {
            const date = scheduleDateInput.value;
            const time = scheduleTimeInput.value;

            if (!date || !time) {
                alert('Выберите дату и время');
                return;
            }

            const scheduled = new Date(`${date}T${time}`);
            const now = new Date();

            if (scheduled <= now) {
                alert('Выбранное время уже прошло');
                return;
            }

            scheduledTime = scheduled.toISOString();
            closeModal(scheduleModal);
            publishPost();
        });
    }

    // Загрузка сохраненных групп
    async function loadSavedGroups() {
        try {
            const response = await fetch('{% url "get_saved_groups" %}');
            const data = await response.json();

            if (data.success) {
                renderVkGroups(data.vk_groups);
                renderTgChannels(data.tg_channels);
            }
        } catch (error) {
            console.error('Ошибка загрузки групп:', error);
        }
    }

    // Отрисовка VK групп
    function renderVkGroups(groups) {
        const container = document.getElementById('vkGroupsList');

        if (groups.length === 0) {
            container.innerHTML = '<div class="no-groups">Нет сохранённых групп</div>';
            return;
        }

        container.innerHTML = groups.map(group => `
            <div class="group-item">
                <label class="group-checkbox">
                    <input type="checkbox" value="${group.id}"
                           onchange="toggleVkGroup('${group.id}')"
                           ${selectedVkGroups.includes(group.id) ? 'checked' : ''}>
                    <span>${group.name}</span>
                </label>
                <button class="delete-btn" onclick="deleteVkGroup('${group.id}')" title="Удалить">✕</button>
            </div>
        `).join('');
    }

    // Отрисовка Telegram каналов
    function renderTgChannels(channels) {
        const container = document.getElementById('tgChannelsList');

        if (channels.length === 0) {
            container.innerHTML = '<div class="no-groups">Нет сохранённых каналов</div>';
            return;
        }

        container.innerHTML = channels.map(channel => `
            <div class="group-item">
                <label class="group-checkbox">
                    <input type="checkbox" value="${channel.id}"
                           onchange="toggleTgChannel('${channel.id}')"
                           ${selectedTgChannels.includes(channel.id) ? 'checked' : ''}>
                    <span>${channel.name}</span>
                </label>
                <button class="delete-btn" onclick="deleteTgChannel('${channel.id}')" title="Удалить">✕</button>
            </div>
        `).join('');
    }

    // Переключение VK группы
    function toggleVkGroup(groupId) {
        const index = selectedVkGroups.indexOf(groupId);
        if (index > -1) {
            selectedVkGroups.splice(index, 1);
        } else {
            selectedVkGroups.push(groupId);
        }
        updateVkCount();
        console.log('Выбранные VK группы:', selectedVkGroups);
    }

    // Переключение Telegram канала
    function toggleTgChannel(channelId) {
        const index = selectedTgChannels.indexOf(channelId);
        if (index > -1) {
            selectedTgChannels.splice(index, 1);
        } else {
            selectedTgChannels.push(channelId);
        }
        updateTgCount();
        console.log('Выбранные Telegram каналы:', selectedTgChannels);
    }

    // Обновление счетчика VK
    function updateVkCount() {
        document.getElementById('vkSelectedCount').textContent = selectedVkGroups.length;
    }

    // Обновление счетчика Telegram
    function updateTgCount() {
        document.getElementById('tgSelectedCount').textContent = selectedTgChannels.length;
    }

    // Открытие/закрытие VK dropdown
    function toggleVkDropdown() {
        const dropdown = document.getElementById('vkDropdown');
        const isOpen = dropdown.style.display === 'block';
        closeAllDropdowns();
        if (!isOpen) {
            dropdown.style.display = 'block';
        }
    }

    function closeVkDropdown() {
        document.getElementById('vkDropdown').style.display = 'none';
    }

    // Открытие/закрытие Telegram dropdown
    function toggleTgDropdown() {
        const dropdown = document.getElementById('tgDropdown');
        const isOpen = dropdown.style.display === 'block';
        closeAllDropdowns();
        if (!isOpen) {
            dropdown.style.display = 'block';
        }
    }

    function closeTgDropdown() {
        document.getElementById('tgDropdown').style.display = 'none';
    }

    // Закрыть все выпадающие списки
    function closeAllDropdowns() {
        document.getElementById('vkDropdown').style.display = 'none';
        document.getElementById('tgDropdown').style.display = 'none';
    }

    // Удаление VK группы
    async function deleteVkGroup(groupId) {
        if (!confirm('Удалить эту группу?')) return;

        try {
            const response = await fetch('{% url "remove_vk_group_token" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ group_id: groupId })
            });

            const data = await response.json();
            if (data.success) {
                selectedVkGroups = selectedVkGroups.filter(id => id !== groupId);
                updateVkCount();
                loadSavedGroups();
            } else {
                alert('Ошибка удаления: ' + data.error);
            }
        } catch (error) {
            alert('Ошибка соединения: ' + error.message);
        }
    }

    // Удаление Telegram канала
    async function deleteTgChannel(channelId) {
        if (!confirm('Удалить этот канал?')) return;

        try {
            const response = await fetch('{% url "remove_tg_channel" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ channel_id: channelId })
            });

            const data = await response.json();
            if (data.success) {
                selectedTgChannels = selectedTgChannels.filter(id => id !== channelId);
                updateTgCount();
                loadSavedGroups();
            } else {
                alert('Ошибка удаления: ' + data.error);
            }
        } catch (error) {
            alert('Ошибка соединения: ' + error.message);
        }
    }

    // Инициализация кнопок toggle
    document.getElementById('toggleVkList').addEventListener('click', toggleVkDropdown);
    document.getElementById('toggleTgList').addEventListener('click', toggleTgDropdown);

    // Загрузка при старте
    document.addEventListener('DOMContentLoaded', function() {
        {% if user %}
        loadSavedGroups();
        {% endif %}
    });

    // Закрытие при клике вне dropdown
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.dropdown-panel') &&
            !e.target.closest('.list-toggle-btn')) {
            closeAllDropdowns();
        }
    });

    // файлы
    const fileInput = document.getElementById('fileInput');
    const fileName = document.getElementById('fileName');
    if (fileInput) {
        fileInput.addEventListener('change', function () {
            if (this.files.length > 0) {
                const names = Array.from(this.files).map(f => f.name).join(', ');
                fileName.textContent = names;
            } else {
                fileName.textContent = '';
            }
        });
    }

    // добавление VK группы
    const vkGroupIdInput = document.querySelector('#vkConnectBtn .social-group-id');
    const vkGroupTokenInput = document.querySelector('#vkConnectBtn .social-group-token');
    const vkAddBtn = document.querySelector('#vkConnectBtn .social-add-btn');

    if (vkAddBtn && vkGroupIdInput && vkGroupTokenInput) {
        vkAddBtn.addEventListener('click', async function() {
            const groupId = vkGroupIdInput.value.trim();
            const groupToken = vkGroupTokenInput.value.trim();

            if (!groupId || !groupToken) {
                alert('Введите ID группы и токен доступа');
                return;
            }

            try {
                const response = await fetch('{% url "save_vk_group_token" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        group_id: groupId,
                        group_token: groupToken
                    })
                });

                const data = await response.json();

                if (data.success) {
                    vkGroupIdInput.value = '';
                    vkGroupTokenInput.value = '';
                    alert(`VK группа ${groupId} добавлена`);
                    loadSavedGroups();
                } else {
                    alert('Ошибка: ' + (data.error || 'не удалось сохранить токен'));
                }
            } catch (error) {
                alert('Ошибка соединения: ' + error.message);
            }
        });
    }

    // добавление Telegram канала
    const tgInput = document.querySelector('#tgConnectBtn .social-input');
    const tgAddBtn = document.querySelector('#tgConnectBtn .social-add-btn');

    if (tgAddBtn && tgInput) {
        tgAddBtn.addEventListener('click', async function() {
            const channelId = tgInput.value.trim();

            if (!channelId) {
                alert('Введите ID канала');
                return;
            }

            try {
                const response = await fetch('{% url "save_tg_channel" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        channel_id: channelId,
                        channel_name: channelId
                    })
                });

                const data = await response.json();

                if (data.success) {
                    tgInput.value = '';
                    alert(`Telegram канал ${channelId} добавлен`);
                    loadSavedGroups();
                } else {
                    alert('Ошибка: ' + (data.error || 'не удалось сохранить канал'));
                }
            } catch (error) {
                alert('Ошибка соединения: ' + error.message);
            }
        });
    }

    // публикация поста
    const publishBtn = document.getElementById('publishBtn');
    if (publishBtn) {
        publishBtn.addEventListener('click', function() {
            // Открываем модальное окно планирования вместо прямой публикации
            scheduleModal.style.display = 'block';
            setTimeout(() => {
                scheduleModal.classList.add('active');
            }, 10);
            updateSchedulePreview();
        });
    }

    // Функция публикации поста
    async function publishPost() {
        const text = document.getElementById('postText').value.trim();
        const files = fileInput.files;

        if (!text && files.length === 0) {
            alert('Добавьте текст или изображение');
            return;
        }

        if (selectedVkGroups.length === 0 && selectedTgChannels.length === 0) {
            alert('Выберите хотя бы одну группу VK или канал Telegram из списка');
            return;
        }

        const formData = new FormData();
        formData.append('text', text);
        formData.append('vk_groups', selectedVkGroups.join(','));
        formData.append('tg_channels', selectedTgChannels.join(','));

        // Добавляем запланированное время если есть
        if (scheduledTime) {
            formData.append('scheduled_time', scheduledTime);
        }

        for (let i = 0; i < files.length; i++) {
            formData.append('files', files[i]);
        }

        publishBtn.disabled = true;
        publishBtn.textContent = scheduledTime ? 'ПЛАНИРОВАНИЕ...' : 'ПУБЛИКАЦИЯ...';

        try {
            const response = await fetch('{% url "publish_post" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                if (scheduledTime) {
                    alert('Пост запланирован! Он будет опубликован в указанное время.');
                } else {
                    alert('Пост успешно опубликован!');
                }

                document.getElementById('postText').value = '';
                fileInput.value = '';
                fileName.textContent = '';

                // Снимаем выбор
                selectedVkGroups = [];
                selectedTgChannels = [];
                scheduledTime = null;
                updateVkCount();
                updateTgCount();
                loadSavedGroups();
            } else {
                let errorMsg = scheduledTime ? 'Ошибка планирования:\n' : 'Ошибка публикации:\n';

                if (data.errors && data.errors.length > 0) {
                    errorMsg += data.errors.join('\n');
                } else {
                    errorMsg += data.error || 'Неизвестная ошибка';
                }

                alert(errorMsg);
            }
        } catch (error) {
            alert('Ошибка соединения: ' + error.message);
        } finally {
            publishBtn.disabled = false;
            publishBtn.textContent = 'PUBLISH';
        }
    }

    // модальное окно профиля
    const profileModal = document.getElementById('profileModal');
    const openProfileBtn = document.getElementById('openProfileModal');
    const closeProfileBtn = document.getElementById('closeProfileModal');

    if (openProfileBtn) {
        openProfileBtn.addEventListener('click', function() {
            profileModal.style.display = 'block';
            setTimeout(() => {
                profileModal.classList.add('active');
            }, 10);
        });
    }

    // модальное окно telegram
    const tgModal = document.getElementById('tgModal');
    const openTgModalBtn = document.getElementById('openTgModal');
    const closeTgModalBtn = document.getElementById('closeTgModal');

    if (openTgModalBtn) {
        openTgModalBtn.addEventListener('click', function() {
            tgModal.style.display = 'block';
            setTimeout(() => {
                tgModal.classList.add('active');
            }, 10);
        });
    }

    if (closeTgModalBtn) {
        closeTgModalBtn.addEventListener('click', () => closeModal(tgModal));
    }

    // telegram авторизация
    const tgSendCodeBtn = document.getElementById('tgSendCodeBtn');
    const tgVerifyCodeBtn = document.getElementById('tgVerifyCodeBtn');
    const tgErrorMessage = document.getElementById('tg-error-message');

    function showTgError(message) {
        tgErrorMessage.textContent = message;
        tgErrorMessage.style.display = 'block';
    }

    function hideTgError() {
        tgErrorMessage.style.display = 'none';
    }

    if (tgSendCodeBtn) {
        tgSendCodeBtn.addEventListener('click', async function() {
            hideTgError();
            const phone = document.getElementById('tgPhone').value.trim();

            if (!phone) {
                showTgError('Введите номер телефона');
                return;
            }

            tgSendCodeBtn.disabled = true;
            tgSendCodeBtn.textContent = 'Отправка...';

            try {
                const response = await fetch('{% url "tg_send_code" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ phone: phone })
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('tgStep1').style.display = 'none';
                    document.getElementById('tgStep2').style.display = 'block';
                } else {
                    showTgError(data.error || 'Ошибка отправки кода');
                }
            } catch (e) {
                showTgError('Ошибка соединения');
            } finally {
                tgSendCodeBtn.disabled = false;
                tgSendCodeBtn.textContent = 'Получить код';
            }
        });
    }

    if (tgVerifyCodeBtn) {
        tgVerifyCodeBtn.addEventListener('click', async function() {
            hideTgError();
            const code = document.getElementById('tgCode').value.trim();
            const password = document.getElementById('tg2faPassword').value;

            if (!code) {
                showTgError('Введите код');
                return;
            }

            tgVerifyCodeBtn.disabled = true;
            tgVerifyCodeBtn.textContent = 'Проверка...';

            try {
                const response = await fetch('{% url "tg_verify_code" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ code: code, password: password })
                });

                const data = await response.json();

                if (data.success) {
                    window.location.reload();
                } else if (data.error === '2fa_required') {
                    document.getElementById('tg2faGroup').style.display = 'block';
                    showTgError('Требуется пароль двухфакторной аутентификации');
                } else {
                    showTgError(data.error || 'Ошибка верификации');
                }
            } catch (e) {
                showTgError('Ошибка соединения');
            } finally {
                tgVerifyCodeBtn.disabled = false;
                tgVerifyCodeBtn.textContent = 'Подтвердить';
            }
        });
    }

    function closeModal(modal) {
        modal.classList.remove('active');
        setTimeout(() => {
            modal.style.display = 'none';
        }, 400);
    }

    if (closeProfileBtn) {
        closeProfileBtn.addEventListener('click', () => closeModal(profileModal));
    }

    window.addEventListener('click', function(event) {
        if (event.target === profileModal) {
            closeModal(profileModal);
        }
        if (event.target === tgModal) {
            closeModal(tgModal);
        }
        if (event.target === scheduleModal) {
            closeModal(scheduleModal);
        }
    });
</script>
</body>
</html>
