{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OmniPost</title>
    <link rel="icon" type="image/png" href="{% static 'images/logo-white.png' %}">
    <link rel="stylesheet" href="{% static 'css/home.css' %}">
</head>
<body{% if user %} data-user-logged-in="true"{% endif %}>
<header>
    <div class="header-content">
        <img src="{% static 'images/logo-white.png' %}" alt="logo" style="width: 80px; height: 80px;">
        <button class="btn-profile" id="openProfileModal">
            <img src="{% static 'images/profile-icon.png' %}" alt="Profile" style="width: 40px; height: 40px;">
        </button>
    </div>
</header>

<div class="container">
    <div class="social-section">
        <div class="social-connect-wrapper">
            <div class="social-connect-btn{% if not vk_connected %} disabled{% endif %}" id="vkConnectBtn" {% if not vk_connected %}style="opacity:0.5;pointer-events:none;"{% endif %}>
                <!-- подсказка vk -->
                <div class="tooltip-trigger" onclick="toggleTooltip('vkTooltip')">ⓘ</div>
                <div class="tooltip-content" id="vkTooltip">
                    <div class="tooltip-header">VK Limitations</div>
                    <div class="tooltip-body">
                        • App not yet moderated<br>
                        • Limited functionality<br>
                        • No image attachments<br>
                        • No text formatting<br>
                        • Platform restrictions apply
                    </div>
                </div>

                <img src="{% static 'images/vk-hlogo.png' %}" alt="VK" class="social-hlogo">
                {% if vk_connected %}
                <div class="social-input-wrapper">
                    <input type="text" class="social-input social-group-id" placeholder="GROUP ID...">
                    <input type="text" class="social-input social-group-token" placeholder="ACCESS TOKEN...">
                    <button type="button" class="social-add-btn">+</button>
                </div>
                {% endif %}
            </div>
            <button type="button" class="list-toggle-btn{% if not vk_connected %} disabled{% endif %}" id="toggleVkList" title="CHOOSE GROUPS"{% if not vk_connected %} disabled style="opacity:0.5;cursor:not-allowed;"{% endif %}>☰</button>
        </div>

        <div class="social-connect-wrapper">
            <div class="social-connect-btn{% if not tg_connected %} disabled{% endif %}" id="tgConnectBtn"{% if not tg_connected %} style="opacity:0.5;pointer-events:none;"{% endif %}>
                <!-- подсказка tg -->
                <div class="tooltip-trigger" onclick="toggleTooltip('tgTooltip')">ⓘ</div>
                <div class="tooltip-content" id="tgTooltip">
                    <div class="tooltip-header">Telegram Features</div>
                    <div class="tooltip-body">
                        • Full functionality<br>
                        • Image attachments supported<br>
                        • Text formatting (Markdown)<br>
                        • HTML support<br>
                        • No platform restrictions
                    </div>
                </div>

                <img src="{% static 'images/tg-hlogo.png' %}" alt="Telegram" class="social-hlogo">
                <div class="social-input-wrapper">
                    <input type="text" class="social-input" placeholder="CHANNEL ID...">
                    <button type="button" class="social-add-btn">+</button>
                </div>
            </div>
            <button type="button" class="list-toggle-btn{% if not tg_connected %} disabled{% endif %}" id="toggleTgList" title="CHOOSE CHANNELS"{% if not tg_connected %} style="opacity:0.5;pointer-events:none;"{% endif %}>☰</button>
        </div>
    </div>

    <!-- выпадающий список vk -->
    <div id="vkDropdown" class="dropdown-panel">
        <div class="dropdown-header">
            <span>VK GROUPS (<span id="vkSelectedCount">0</span> CHOSEN)</span>
            <button class="dropdown-close" onclick="closeVkDropdown()">✕</button>
        </div>
        <div id="vkGroupsList" class="dropdown-body">
            <div class="no-groups">NO GROUPS SAVED</div>
        </div>
    </div>

    <!-- выпадающий список tg -->
    <div id="tgDropdown" class="dropdown-panel">
        <div class="dropdown-header">
            <span>TG CHANNELS (<span id="tgSelectedCount">0</span> CHOSEN)</span>
            <button class="dropdown-close" onclick="closeTgDropdown()">✕</button>
        </div>
        <div id="tgChannelsList" class="dropdown-body">
            <div class="no-groups">NO CHANNELS SAVED</div>
        </div>
    </div>

    <div class="editor-section">
        <div class="editor-wrapper">
            <textarea id="postText" placeholder="WRITE YOUR POST HERE..."></textarea>

            <div class="attachment-bar">
                <button type="button" class="attach-btn" onclick="document.getElementById('fileInput').click()">
                    &#128206; ATTACH FILE
                </button>
                <input type="file" id="fileInput" class="file-input" multiple>
                <span class="file-name" id="fileName"></span>

                {% if tg_connected %}
                <div class="formatting-buttons">
                    <button type="button" class="format-btn" title="Bold" onclick="insertFormatting('bold')"><b>B</b></button>
                    <button type="button" class="format-btn" title="Italic" onclick="insertFormatting('italic')"><i>I</i></button>
                    <button type="button" class="format-btn" title="Monospace" onclick="insertFormatting('mono')"><code>Mono</code></button>
                    <button type="button" class="format-btn" title="Strikethrough" onclick="insertFormatting('strike')"><s>S</s></button>
                    <button type="button" class="format-btn" title="Underline" onclick="insertFormatting('underline')"><u>U</u></button>
                </div>
                {% endif %}

                <button type="button" class="schedule-btn" id="scheduleBtn" title="Запланировать публикацию">
                    &#128197;
                </button>
            </div>
        </div>
    </div>

    <div class="publish-section">
        <button type="button" class="btn-publish" id="publishBtn">PUBLISH</button>
    </div>

    <!-- недавние посты -->
    <div class="recent-posts-section">
        <h3>Recent Posts</h3>
        <div class="recent-posts-container" id="recentPostsList">
            <div class="no-posts">NO RECENT POSTS</div>
        </div>
    </div>
</div>

<!-- модальное окно профиля -->
<div id="profileModal" class="modal">
    <div class="modal-content modal-profile">
        <span class="close-modal" id="closeProfileModal">&times;</span>

        {% if user %}
        <!-- авторизован -->
        <div class="profile-info">
            <div class="profile-email">{{ user.email }}</div>

            <div class="profile-socials">
                {% if vk_connected %}
                <a href="{% url 'vk_disconnect' %}" class="social-login-btn vk connected" title="DISABLE VK">
                    <img src="{% static 'images/vkon-icon.png' %}" alt="VK" class="icon-default">
                    <img src="{% static 'images/vkoff-icon.png' %}" alt="VK" class="icon-hover">
                </a>
                {% else %}
                <a href="{% url 'vk_login' %}" class="social-login-btn vk" title="CONNECT VK">
                    <img src="{% static 'images/vk-icon.png' %}" alt="VK">
                </a>
                {% endif %}

                {% if tg_connected %}
                <a href="{% url 'tg_disconnect' %}" class="social-login-btn tg connected" title="DISABLE TG">
                    <img src="{% static 'images/tgon-icon.png' %}" alt="Telegram" class="icon-default">
                    <img src="{% static 'images/tgoff-icon.png' %}" alt="Telegram" class="icon-hover">
                </a>
                {% else %}
                <button type="button" class="social-login-btn tg" id="openTgModal" title="CONNECT TG">
                    <img src="{% static 'images/tg-icon.png' %}" alt="Telegram">
                </button>
                {% endif %}
            </div>

            <a href="{% url 'logout' %}" class="btn-logout">Logout</a>
        </div>
        {% else %}
        <!-- не авторизован -->
        <div id="error-message" class="error-message" style="display: none;"></div>

        <form id="authForm" method="POST" action="{% url 'email_auth' %}">
            {% csrf_token %}
            <input type="hidden" name="action" id="authAction" value="login">

            <div class="input-group">
                <label>Email</label>
                <input type="email" name="email" id="email" required>
            </div>

            <div class="input-group">
                <label>Password</label>
                <input type="password" name="password" id="password" required>
            </div>

            <div class="auth-buttons">
                <button type="submit" class="btn-login" onclick="document.getElementById('authAction').value='login'">Login</button>
                <button type="submit" class="btn-register" onclick="document.getElementById('authAction').value='register'">Register</button>
            </div>
        </form>

        <div class="divider">or</div>

        <a href="{% url 'google_login' %}" class="btn-google">
            <img src="{% static 'images/google-icon.png' %}" alt="Google" style="width: 20px; height: 20px;">
            LOGIN WITH GOOGLE
        </a>
        {% endif %}
    </div>
</div>

{% if error %}
<script>
    document.getElementById('error-message').textContent = "{{ error }}";
    document.getElementById('error-message').style.display = 'block';
    document.getElementById('profileModal').style.display = 'block';
    document.getElementById('profileModal').classList.add('active');
</script>
{% endif %}

<!-- модальное окно tg авторизации -->
<div id="tgModal" class="modal">
    <div class="modal-content modal-tg">
        <span class="close-modal" id="closeTgModal">&times;</span>
        <h3 style="margin-bottom: 20px; text-align: center; color: #ffffff;">CONNECT TG</h3>

        <div id="tg-error-message" class="error-message" style="display: none;"></div>

        <!-- ввод номера телефона -->
        <div id="tgStep1">
            <div class="input-group">
                <label>PHONE NUMBER</label>
                <input type="tel" id="tgPhone" placeholder="+7 999 123 4567" required>
            </div>
            <button type="button" class="btn-login" id="tgSendCodeBtn" style="width: 100%;">GET THE CODE</button>
        </div>

        <!-- ввод кода -->
        <div id="tgStep2" style="display: none;">
            <div class="input-group">
                <label>TG code</label>
                <input type="text" id="tgCode" placeholder="12345" required>
            </div>
            <div class="input-group" id="tg2faGroup" style="display: none;">
                <label>PASSWORD 2FA</label>
                <input type="password" id="tg2faPassword" placeholder="YOUR PASSWORD">
            </div>
            <button type="button" class="btn-login" id="tgVerifyCodeBtn" style="width: 100%;">CONFIRM</button>
        </div>
    </div>
</div>

<!-- модальное окно планирования -->
<div id="scheduleModal" class="modal">
    <div class="modal-content modal-schedule">
        <span class="close-modal" id="closeScheduleModal">&times;</span>
        <h3 style="margin-bottom: 20px; text-align: center;">Schedule Publication</h3>

        <div class="schedule-form">
            <div class="input-group">
                <label>Date</label>
                <input type="date" id="scheduleDate" required>
            </div>

            <div class="input-group">
                <label>Time</label>
                <input type="time" id="scheduleTime" required>
            </div>

            <div class="schedule-info">
                <p id="schedulePreview"></p>
            </div>

            <div class="schedule-buttons">
                <button type="button" class="btn-schedule-now" id="publishNowBtn">Publish Now</button>
                <button type="button" class="btn-schedule-later" id="publishLaterBtn">Schedule</button>
            </div>
        </div>
    </div>
</div>

<footer class="footer">
    <div class="footer-content">
        <span>© {% now "Y" %} OmniPost</span>
        <span>•</span>
        <a href="https://github.com/mwh4t/omnipost" target="_blank" rel="noopener noreferrer">GitHub</a>
    </div>
</footer>

<script src="{% static 'js/home.js' %}"></script>
</body>
</html>
